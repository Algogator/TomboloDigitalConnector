box: fcclab/tombolo
services:
  - id: mdillon/postgis:9.5
    env:
      POSTGRES_PASSWORD: postgres
build:
  steps:
    - script:
      name: Show basic information
      code: |
        echo $JAVA_HOME
        java -version
        javac -version
        gradle -v
    - script:
      name: Set up Postgres env variables
      code: |
        export PGHOST=$POSTGIS_PORT_5432_TCP_ADDR
        export PGPORT=$POSTGIS_PORT_5432_TCP_PORT
        export PGUSER=postgres
        export PGPASSWORD=postgres
    - script:
      name: Wait for Postgres to come up
      code: |
        while ! psql -c "\l"; do
          echo "PostgresSQL unavailable, waiting..."
          sleep 3
        done
    - script:
      name: Set up test database
      code: |
        createdb tombolo_test
        psql -d tombolo_test < src/main/resources/sql/create_database.sql
        psql -d tombolo_test < src/test/resources/sql/initial_fixtures.sql
    - script:
      name: Run gradle build & test
      code: |
        export DATABASE_URI=jdbc:postgresql://$POSTGIS_PORT_5432_TCP_ADDR:$POSTGIS_PORT_5432_TCP_PORT/tombolo_test
        gradle -s clean build copyDeps
